from __future__ import annotations

from src.models.openai_client import chat_complete_ex


def build_section_prompt(country: str, problem_key: str, problem_ru: str | None, messages: list[str], links: list[str], max_messages: int) -> list[dict]:
    msgs_block = "\n\n".join([f"- {m}" for m in messages[:max_messages]])
    problem_title = f"{problem_key}" + (f" / {problem_ru}" if problem_ru else "")
    sys = (
        "Ты профессиональный социолог. Готовишь отчеты для государственных и международных организаций. "
        f"Проанализируй высказывания жителей государства {country} в соцсетях и опиши проблемы, которые они поднимают. "
        "Пиши на русском языке, чётко и по делу. Факты/события в приоритете; анализ — кратко. "
        f"Фокус — {country}. "
        "Строгое требование: примеры и цитаты должны относиться к целевой стране; упоминания других стран допустимы только как внешний контекст, но НЕЛЬЗЯ менять принадлежность события/участников. "
        "Если пример/цитата не относится к целевой стране — пропусти его/её."
    )
    usr = f"""
Тип проблемы: {problem_title}

Высказывания (до {max_messages} шт):
{msgs_block}

Задача:
1) Дай 3-5 конкретных примера с понятным контекстом: где/когда/кто/что произошло. (Если примеров меньше 3, то дай столько, сколько есть.)
2) Акцент на проблемах рядовых жителей {country}. Краткость приветствуется: раскрывай тему через примеры.

Ограничения:
- Не добавляй общий итоговый вывод по разделу.
- Не используй технические маркеры разметки (##, **). Заголовки будут расставлены редактором документа.
- Примеры — только про события/случаи, относящиеся к {country}. Не подменяй страны/географию.
- Цитаты — только от жителей {country}; если нет валидной цитаты, пропусти.
- Вставь блок «Источники:» с предоставленными ссылками, если они есть.

Структура:
- «Описание проблемы» — 3–5 предложений, только то, что не повторяется в примерах.
- «Пример 1», «Пример 2», …: кратко где/когда/кто/что и последствия (каждый пример 3–4 строки).
- «Цитаты»: 1–2 информативные цитаты к КАЖДОМУ примеру: сначала ОРИГИНАЛ (без перевода), затем пробел и перевод на русский в круглых скобках. Если нет оригинала — цитату пропусти.
- «Источники»: список ссылок из входных данных.

Важно:
- Избегай повторов между «Описание проблемы/Пример/Цитата». Детали — только в примерах. Если цитата повторяет «что произошло», выбери другую.
- Не добавляй заголовок «Анализ». Вкладывай анализ (1–2 предложения) внутрь каждого примера.
"""
    return [{"role": "system", "content": sys}, {"role": "user", "content": usr.strip()}]


def generate_section(cfg, country: str, problem_key: str, group: dict) -> tuple[str, dict]:
    messages = build_section_prompt(
        country,
        problem_key,
        group.get("problem_ru"),
        group.get("messages", []),
        group.get("links", []),
        cfg.max_messages_per_problem,
    )
    content, usage = chat_complete_ex(
        cfg.models.generate,
        messages,
        cfg.temperature,
        cfg.max_tokens,
    )
    return content, usage


