from __future__ import annotations

from src.models.openai_client import chat_complete_ex


EDITOR_SYSTEM = (
    "Ты выступаешь в роли редактора‑верификатора социологического отчёта. "
    "Требования: \n"
    "- Удали разделы/заголовки вида 'Анализ' и любые общие выводы.\n"
    "- Расширь 'Описание проблемы' так, чтобы читателю без подготовки было понятно, о чём речь (кратко и по делу).\n"
    "- Избегай повторов между описанием, примерами и цитатами.\n"
    "- Цитаты ДОЛЖНЫ быть только от жителей целевой страны; если есть сомнение — цитату убери.\n"
    "- Цитаты не должны быть рекламой или промо‑сообщениями; рекламные — удалить.\n"
    "- Проверяй логику и факты внутри цитат и текста: явные нелепости (например, '48 часов в сутки') исправь или замени на корректную цитату/формулировку.\n"
    "- Сохрани структуру: 'Описание проблемы', 'Пример 1/2/…', 'Цитаты', 'Источники'.\n"
    "- Не добавляй технические маркеры форматирования (##, **). Заголовки расставит редактор документа.\n"
    "- Строго соблюдай фактологию: НИКОГДА не изменяй факты (имена, даты, места, страны, гражданство, числа).\n"
    "- Если пример или цитата не относится к целевой стране — УДАЛИ её/его, не подменяй страну и не выдумывай детали.\n"
    "- Не преобразовывай упоминания других стран так, как будто речь о целевой стране; вместо этого исключай такие фрагменты.\n"
    "- Если невозможно оставить корректные примеры/цитаты по требованиям — удаляй соответствующие фрагменты без замены их выдуманными.\n"
    "- Цитаты должны содержать оригинал высказывания и перевод на русский в круглых скобках. Если нет оригинала — цитату удаляй.\n"
    "- Темы поддержки ЛГБТ не обсуждаем и в отчёт не включаем: упоминания о поддержке ЛГБТ, лозунги, активизм — удаляй без объяснений и замен.\n"
    "- Если раздел 'Источники' пуст или ссылки удалены — не добавляй заголовок 'Источники' и не оставляй пояснений причин удаления.\n"
)


def build_editor_prompt(country: str, raw_section: str, links: list[str]) -> list[dict]:
    sources_block = "\n".join([f"- {u}" for u in links]) if links else ""
    user = f"""
Страна: {country}

Задача: отредактируй раздел согласно требованиям. Если цитаты не соответствуют требованиям, удали их. Если логика нарушена — исправь формулировку или убери проблемный фрагмент.

Текст раздела:
{raw_section}

Источники (ссылки):
{sources_block}
"""
    return [{"role": "system", "content": EDITOR_SYSTEM}, {"role": "user", "content": user.strip()}]


def edit_section(cfg, country: str, raw_section_text: str, links: list[str]) -> tuple[str, dict]:
    messages = build_editor_prompt(country, raw_section_text, links)
    content, usage = chat_complete_ex(cfg.models.editor, messages, cfg.temperature, cfg.max_tokens)
    return content, usage


